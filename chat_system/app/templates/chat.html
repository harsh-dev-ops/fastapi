<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Chat</title>
    <style>
        .chat-container { display: flex; height: 100vh; }
        .sidebar { width: 250px; border-right: 1px solid #ccc; }
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .messages { flex: 1; overflow-y: auto; padding: 10px; }
        .message-input { padding: 10px; border-top: 1px solid #ccc; }
        .unread { background-color: #e3f2fd; }
        .read-receipt { font-size: 0.8em; color: #666; }
        .unread-count { 
            background-color: red; 
            color: white; 
            border-radius: 50%; 
            padding: 2px 6px; 
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="sidebar">
            <h2>Chats</h2>
            <div id="chat-list">
                <!-- Chats will be populated here -->
            </div>
        </div>
        
        <div class="chat-area">
            <div id="chat-header">
                <h3>Select a chat</h3>
            </div>
            <div class="messages" id="messages-container"></div>
            <div class="message-input">
                <input type="text" id="message-input" placeholder="Type a message...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        const userId = "user1"; // In real app, get from authentication
        let currentChat = null;
        let chatType = null; // 'user' or 'group'
        const ws = new WebSocket(`ws://localhost:8000/ws/${userId}`);
        let unreadCounts = {};

        // Connect to WebSocket
        ws.onopen = () => {
            console.log("WebSocket connected");
            loadChatList();
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            handleMessage(data);
        };

        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        // Handle incoming messages
        function handleMessage(data) {
            switch(data.type) {
                case 'new_message':
                    displayMessage(data);
                    if(data.unread) {
                        updateUnreadCount(data.sender_id, 1);
                    }
                    break;
                    
                case 'read_update':
                    updateReadStatus(data.message_id, data.reader_id);
                    break;
                    
                case 'group_read_update':
                    updateReadStatus(data.message_id, data.reader_id);
                    break;
            }
        }

        // Display message in UI
        function displayMessage(message) {
            if((chatType === 'user' && message.sender_id === currentChat) || 
               (chatType === 'group' && message.receiver_id === currentChat)) {
                
                const container = document.getElementById('messages-container');
                const msgElement = document.createElement('div');
                msgElement.className = message.unread ? 'message unread' : 'message';
                msgElement.dataset.messageId = message.message_id;
                
                msgElement.innerHTML = `
                    <strong>${message.sender_id}:</strong> ${message.content}
                    <div class="read-receipt">${getReadStatus(message)}</div>
                `;
                container.appendChild(msgElement);
                container.scrollTop = container.scrollHeight;
                
                // Mark as read if current chat is open
                if(!message.unread) {
                    markAsRead(message.message_id);
                }
            }
        }

        // Get read status text
        function getReadStatus(message) {
            if(message.is_group) {
                return "Seen by some";
            }
            return message.unread ? "Unread" : "Read";
        }

        // Update read status in UI
        function updateReadStatus(messageId, readerId) {
            const msgElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if(msgElement) {
                const readReceipt = msgElement.querySelector('.read-receipt');
                if(readReceipt) {
                    readReceipt.textContent = `Read by ${readerId}`;
                    msgElement.classList.remove('unread');
                }
            }
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if(!content || !currentChat) return;
            
            fetch(`http://localhost:8000/api/send/${currentChat}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    sender_id: userId,
                    content: content,
                    is_group: chatType === 'group'
                })
            });
            
            input.value = '';
        }

        // Mark message as read
        function markAsRead(messageId) {
            ws.send(JSON.stringify({
                type: 'read_receipt',
                message_id: messageId,
                group_id: chatType === 'group' ? currentChat : null
            }));
        }

        // Load chat list with unread counts
        async function loadChatList() {
            const response = await fetch(`http://localhost:8000/api/unread-count/${userId}`);
            const data = await response.json();
            
            // In real app, fetch actual chat list from API
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';
            
            // Sample chat data (replace with API call)
            const chats = [
                { id: 'user2', name: 'User 2', type: 'user', unread: data.count },
                { id: 'group1', name: 'Group Chat', type: 'group', unread: 3 }
            ];
            
            chats.forEach(chat => {
                const chatElement = document.createElement('div');
                chatElement.className = 'chat-item';
                chatElement.innerHTML = `
                    <div onclick="selectChat('${chat.id}', '${chat.type}')">
                        ${chat.name}
                        ${chat.unread > 0 ? 
                          `<span class="unread-count">${chat.unread}</span>` : ''}
                    </div>
                `;
                chatList.appendChild(chatElement);
                unreadCounts[chat.id] = chat.unread;
            });
        }

        // Select chat to open
        function selectChat(chatId, type) {
            currentChat = chatId;
            chatType = type;
            
            // Update UI
            document.getElementById('chat-header').innerHTML = `
                <h3>${chatId} (${type})</h3>
            `;
            
            // Clear messages container
            document.getElementById('messages-container').innerHTML = '';
            
            // Reset unread count
            if(unreadCounts[chatId] > 0) {
                unreadCounts[chatId] = 0;
                document.querySelector(`.chat-item:nth-child(${Array.from(document.querySelectorAll('.chat-item')).indexOf(document.querySelector(`[onclick*="${chatId}"]`).parentNode) + 1}) .unread-count`).textContent = '0';
            }
            
            // Load chat history (implement this separately)
            loadChatHistory(chatId, type);
        }

        // Update unread count in UI
        function updateUnreadCount(chatId, increment) {
            if(!unreadCounts[chatId]) unreadCounts[chatId] = 0;
            unreadCounts[chatId] += increment;
            
            const chatElement = document.querySelector(`[onclick*="${chatId}"]`);
            if(chatElement) {
                let countElement = chatElement.querySelector('.unread-count');
                if(!countElement) {
                    countElement = document.createElement('span');
                    countElement.className = 'unread-count';
                    chatElement.appendChild(countElement);
                }
                countElement.textContent = unreadCounts[chatId];
            }
        }
    </script>
</body>
</html>